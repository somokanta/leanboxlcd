<?php

/**
 * Files containing list of functions for petty cash functionalities
 */

/**
 * Implements hook_menu
 */
function leanbox_petty_cash_menu() {
   $items = array();
   $items['petty-cash/credit'] = array(
     'title' => 'petty cash credit',
     'page callback' => 'drupal_get_form',
     'page arguments' => array('upload_petty_cash_callback'),
     'access arguments' => array('upload petty cash'),
     'type' => MENU_CALLBACK,
     'file' => 'form/leanbox_petty_cash.form.inc',
   );
   $items['petty-cash/debit'] = array(
     'title' => 'petty cash credit',
     'page callback' => 'drupal_get_form',
     'page arguments' => array('upload_petty_cash_callback'),
     'access arguments' => array('upload petty cash'),
     'type' => MENU_CALLBACK,
     'file' => 'form/leanbox_petty_cash.form.inc',
   );
   $items['petty-cash-voucher/delete'] = array(
     'title' => 'petty cash voucher',
     'page callback' => 'drupal_get_form',
     'page arguments' => array('revert_petty_cash_callback'),
     'access arguments' => array('upload petty cash'),
     'type' => MENU_CALLBACK,
     'file' => 'form/leanbox_petty_cash.form.inc',
   );
   return $items;
}

/**
 * Implement hook_permission()
 *  Add custom permission for petty cash
 */
function leanbox_petty_cash_permission() {
   return array(
     'upload petty cash' => array(
       'title' => t('upload petty cash'),
       'description' => t('upload petty cash for details')
     )
   );
}

/**
 * 
 * Implements hook_feeds_presave($source, $entity, $item)
 */
function leanbox_petty_cash_feeds_presave($source, $entity, $item, $entity_id) {
   foreach ($item as $key => $value) {
      $item[$key] = mb_convert_encoding($value, 'UTF-8', 'UTF-8');
   }
   if ($entity->feeds_item->id == 'petty_cash_master') {
      foreach ($item as $key => $val) {
         if ($key === 'type') {
            $field = field_info_field('field_petty_cash_type');
            $allowed_values = list_allowed_values($field);
            $val = strtolower($val);
            if (!array_key_exists($val, $allowed_values)) {
               drupal_set_message("Please enter correct value for $key " . implode($allowed_values, ','), 'error');
               $entity->feeds_item->skip = TRUE;
            }
            else {
               $entity->field_petty_cash_type['und'][0]['value'] = $val;
            }
         }
      }
   }
}

/**
 * Implements hook_taxonomy_term_presave($term)
 * @param type $term
 */
function leanbox_petty_cash_taxonomy_term_presave($term) {
   if ($term->vocabulary_machine_name === 'petty_cash') {
      if (!isset($term->original->name) || ($term->original->name != $term->name)) {
         $user_id = $GLOBALS['user']->uid;
         $distributor_id = change_feeds_import_get_distributor_id($user_id);

         $term_type = $term->field_petty_cash_type['und'][0]['value'];
         $term_head = $term->field_petty_cash_head['und'][0]['value'];
         $term_subhead = $term->field_petty_cash_subhead['und'][0]['value'];
         $term->name = $term_type . "-" . $term_head . "-" . $term_subhead;
         $term->field_petty_cash_distributor['und'][0]['uid'] = $distributor_id;
      }
   }
}

/**
 * 
 * @param type $distributor_id
 */
function _get_latest_balance($distributor_id) {
   $max_billing_id_new = 0;
   if (!empty($distributor_id)) {
      $query = db_select('petty_cash', 'cb');
      $query->addExpression('MAX(id)', 'max');
      $query->condition('distributor_id', $distributor_id);
      $max_billing_id_new = $query->execute()->fetchField();
   }
   return $max_billing_id_new;
}
